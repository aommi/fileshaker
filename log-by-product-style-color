import os
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from datetime import datetime
from pathlib import Path
import time
#from msal import PublicClientApplication #this is for using oneDrive
# # Configurable setting
DELAY=1.1

# Step 1: Define the scope and authenticate for both sheets
scope = ['https://spreadsheets.google.com/feeds', 'https://www.googleapis.com/auth/drive']

# Define credentials paths
base_dir = Path('C:/python-projects/fileshaker')  # Replace with your base directory if needed
credentials_path = base_dir / 'secret'
renamer_credentials_path = credentials_path / 'sheet-reader-key.json'
logger_credentials_path = credentials_path /  'sheet-writer-key.json'



# Authenticate for Renamer Sheet
renamer_credentials = ServiceAccountCredentials.from_json_keyfile_name(str(renamer_credentials_path), scope)
renamer_client = gspread.authorize(renamer_credentials)

# Authenticate for Shake Logger Sheet
logger_credentials = ServiceAccountCredentials.from_json_keyfile_name(str(logger_credentials_path), scope)
logger_client = gspread.authorize(logger_credentials)

# Step 2: Open the sheets by their URLs
renamer_sheet_url = 'https://docs.google.com/spreadsheets/d/12_sh_2ncWKpIbKKxkXBNCdcmMVdaXf-NUww7MotNxRc/edit?usp=sharing'
logger_sheet_url = 'https://docs.google.com/spreadsheets/d/1fU1YOUv_DAzIb0PBvx__KfHoZ2EqXymOqnqCgrUMxJc/edit?usp=sharing'

# Open sheets
renamer_sheet = renamer_client.open_by_url(renamer_sheet_url).sheet1
logger_sheet = logger_client.open_by_url(logger_sheet_url).sheet1

# Step 3: Read data from the Renamer Sheet
data = renamer_sheet.get_all_records()  # Get all rows as a list of dictionaries
#print(data[0].keys())


# Step 4: Prepare file paths and date
source_folder_path = base_dir  / 'assets'/'files-to-shake' 
today_date = datetime.now().strftime("%Y-%m-%d")

# Step 5: Loop through the rows in the Renamer Sheet
for row in data:
    vpn = str(row['VPN']).lower()  # Convert VPN to string
    alt_vpn=str(row['alt-VPN']).lower()
    primary_name = row['Primary Name']
    notes = row.get('Notes', '')  # Notes column from the Renamer sheet (default to empty)
    eta=row.get('ETA','')

    # Skip processing if VPN is blank
    if not vpn:
        print("Skipping row with blank VPN value.")
        continue
    
    # Search for files containing the VPN in their name
    files_to_process = [
        source_folder_path / filename
        for filename in os.listdir(source_folder_path)
        if (vpn in filename.lower() or alt_vpn in filename.lower())and not (source_folder_path / filename).is_dir()
    ]
    
    # Skip processing if no matching files are found
    if not files_to_process:
        print(f"No matching files found for VPN '{vpn}'. Skipping processing.")
        continue

    # Sort the files
    files_to_process.sort()
    """
    
    files_to_process.sort(key=lambda filepath: (
    0 if 'main' in str(filepath).lower()
    else 1 if 'alt' in str(filepath).lower()
    else 2, filepath
))
    files_to_process.sort(key=lambda filepath: (
        0 if 'A1' in str(filepath).lower()
        else 1 if 'E1' in str(filepath).lower()
        else 1 if 'D1' in str(filepath).lower()
        else 1 if 'C1' in str(filepath).lower()
        else
        2, filepath
))
"""
    
    # Initialize logging variables
    is_primary_moved = False
    num_alts = 0
    alt_folder_name_logged = ""

    if files_to_process:
        # Rename and move the first file
        first_file = files_to_process[0]
        file_extension = first_file.suffix

        # Process the remaining files (Alt files)
        for index, file_path in enumerate(files_to_process[1:], start=1):
            file_extension = file_path.suffix
            num_alts += 1

    # Log actions to the Shake Logger Sheet
    logger_sheet.append_row([
        datetime.now().strftime("%Y-%m-%d %H:%M:%S"),  # Date
        vpn,                                           # Search key
        primary_name,                                  # Primary Name
        "No",                                          # Is Primary moved
        num_alts,                                      # Number of Alts
        notes,                                         # Notes
        "",  # Primary folder
        alt_folder_name_logged,                        # Alt Folder Name
        eta                                            # Current ETA Date
    ])
    time.sleep(DELAY)
#it worked